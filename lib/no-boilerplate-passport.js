// Generated by CoffeeScript 1.9.1
(function() {
  var _, configureProviderStrategy, debug, init, passport, providerSchema, rootSchema, validate;

  _ = require('lodash');

  debug = require('debug')('no-boilerplate::passport');

  passport = require('passport');

  validate = require('jsonschema').validate;

  rootSchema = {
    type: 'object',
    properties: {
      baseURL: {
        type: 'string'
      },
      providers: {
        type: 'object',
        additionalProperties: true
      }
    },
    required: ['baseURL', 'providers']
  };

  providerSchema = {
    type: 'object',
    properties: {
      paths: {
        type: 'object',
        properties: {
          start: {
            type: 'string'
          },
          callback: {
            type: 'string'
          },
          success: {
            type: 'string'
          },
          failure: {
            type: 'string'
          }
        },
        required: ['start', 'callback', 'success', 'failure']
      },
      config: {
        type: 'object'
      },
      handler: {
        type: 'object',
        properties: {
          module: {
            type: 'string'
          },
          "function": {
            type: 'string'
          }
        }
      }
    },
    additionalProperties: false
  };

  init = function(app, config) {
    var baseURL;
    if (!validate(config, rootSchema)) {
      throw new Error('Bad configuration object');
    }
    baseURL = config.baseURL;
    debug('Base URL for Passport configuration', baseURL);
    return _.each(config.providers, function(providerConfig, providerName) {
      var strategyName;
      if (!validate(providerConfig, providerSchema)) {
        throw new Error('Bad configuration object for provider ' + providerName);
      }
      strategyName = 'no-boilerplate-' + providerName + '-auth-strategy';
      configureProviderStrategy(strategyName, baseURL, providerName, providerConfig);
      debug('Setting up start endpoint on', providerConfig.paths.start);
      app.get(providerConfig.paths.start, function(req, res, next) {
        return passport.authorize(strategyName)(req, res, next);
      });
      debug('Setting up callback endpoint on', providerConfig.paths.callback);
      return app.get(providerConfig.paths.callback, function(req, res, next) {
        var handler, options;
        options = {
          successRedirect: providerConfig.paths.success,
          failureRedirect: providerConfig.paths.failure
        };
        handler = function(err, user, info) {
          if (err) {
            debug('Failed to authorize:', err);
            return res.redirect(options.failureRedirect);
          }
          return res.redirect(options.successRedirect);
        };
        return passport.authorize(strategyName, options, handler)(req, res, next);
      });
    });
  };

  configureProviderStrategy = function(strategyName, baseURL, providerName, providerConfig) {
    var Strategy, strategy, strategyOptions;
    Strategy = require('passport-' + providerName).Strategy;
    strategyOptions = providerConfig.config;
    strategyOptions.callbackURL = baseURL + providerConfig.paths.callback;
    strategy = new Strategy(strategyOptions, function(token, tokenSecret, profile, done) {
      var handlerFunction, handlerModule;
      if (_.isFunction(providerConfig.handler)) {
        handlerFunction = providerConfig.handler;
      } else if (_.isObject(providerConfig.handler)) {
        handlerModule = require(providerConfig.handler.module);
        handlerFunction = handlerModule.exports[providerConfig.handler["function"]];
      } else if (_.isString(providerConfig.handler)) {
        handlerFunction = eval(providerConfig.handler);
      } else {
        throw new Error('Unsupported handler function type for provider ' + providerName);
      }
      return handlerFunction(token, tokenSecret, profile, done);
    });
    return passport.use(strategyName, strategy);
  };

  module.exports = init;

}).call(this);
